name: Fuzz Testing

on:
  schedule:
    # Run fuzzing every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  proptest:
    name: Property-Based Testing
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true

    - name: Install GForth (differential oracle)
      run: sudo apt-get update && sudo apt-get install -y gforth

    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-proptest-${{ hashFiles('**/Cargo.lock') }}

    - name: Run property-based tests
      run: |
        cd tests/fuzz
        cargo test --lib -- --test-threads=1
      env:
        PROPTEST_CASES: 1000

    - name: Run corpus tests
      run: |
        cd tests/fuzz
        cargo test corpus_tests --lib

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: proptest-failures
        path: tests/fuzz/proptest-regressions/

  fuzz:
    name: LibFuzzer Testing
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust nightly
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly
        override: true

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-fuzz-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzzer (5 minutes)
      run: |
        cd tests/fuzz
        cargo fuzz run fuzz_parser -- -max_total_time=300
      continue-on-error: true

    - name: Upload artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: fuzz-artifacts
        path: tests/fuzz/artifacts/
